<html>
  <head>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link
      rel="stylesheet"
      as="style"
      onload="this.rel='stylesheet'"
      href="https://fonts.googleapis.com/css2?display=swap&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&amp;family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800"
    />
    <title>CIST Bus Times</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
      // Tailwind ダークモード有効化
      tailwind.config = {
        darkMode: 'media',
      }
    </script>
    <style>
      html, body {
        height: 100%;
        min-height: 100vh;
      }
      body {
        background: #f8fafc;
        color: #101519;
        transition: background 0.2s, color 0.2s;
      }
       .bg-e9eef1 { background-color: #d7dfe3; }
       input[type="time"] {
  position: relative;
}

input[type="time"]::-webkit-calendar-picker-indicator {
    position: absolute;
    opacity: 0;
  }
      @media (prefers-color-scheme: dark) {
        body {
          background: #181f26;
          color: #f3f4f6;
        }
        .bg-gray-50 { background-color: #181f26 !important; }
        .text-101519 { color: #f3f4f6 !important; }
        .border { border-color: #2d3748 !important; }
        .bg-eaeef1 { background-color: #232b34 !important; }
        .bg-e9eef1 { background-color: #232b34 !important; }
        .text-5a758c { color: #a0aec0 !important; }
        .text-5c758a { color: #a0aec0 !important; }
      }
      .fullscreen-modal {
        position: fixed;
        inset: 0;
        z-index: 50;
        background: rgba(24,31,38,0.95);
        color: #f3f4f6;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.2s;
      }
      @keyframes fadeIn {
        from { opacity: 0;}
        to { opacity: 1;}
      }
      .modal-content {
        background: #232b34;
        border-radius: 1rem;
        padding: 2rem;
        min-width: 320px;
        max-width: 90vw;
        box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      }
      .modal-close {
        position: absolute;
        top: 2rem;
        right: 2rem;
        background: transparent;
        border: none;
        color: #f3f4f6;
        font-size: 2rem;
        cursor: pointer;
      }
      @media (min-width: 640px) {
        .modal-content { min-width: 400px; }
      }
    </style>
  </head>
  <body class="transition-colors duration-200">
    <div
      class="relative flex size-full min-h-screen flex-col bg-gray-50 justify-between group/design-root overflow-x-hidden"
      style='--select-button-svg: url(&apos;data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%2724px%27 height=%2724px%27 fill=%27rgb(90,117,140)%27 viewBox=%270 0 256 256%27%3e%3cpath d=%27M181.66,170.34a8,8,0,0,1,0,11.32l-48,48a8,8,0,0,1-11.32,0l-48-48a8,8,0,0,1,11.32-11.32L128,212.69l42.34-42.35A8,8,0,0,1,181.66,170.34Zm-96-84.68L128,43.31l42.34,42.35a8,8,0,0,0,11.32-11.32l-48-48a8,8,0,0,0-11.32,0l-48,48A8,8,0,0,0,85.66,85.66Z%27%3e%3c/path%3e%3c/svg%3e&apos;); font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;'
    >
      <div id="searchArea">
        <div class="flex items-center bg-gray-50 p-4 pb-2 justify-between">
          <div class="text-101519 flex size-12 shrink-0 items-center" data-icon="ArrowLeft" data-size="24px" data-weight="regular">
            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
              <path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path>
            </svg>
          </div>
          <h2 class="text-101519 text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">CIST Bus Times</h2>
        </div>
        <form id="busForm">
          <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
            <label class="flex flex-col min-w-40 flex-1">
              <p class="text-101519 text-base font-medium leading-normal pb-2">From</p>
              <select
                id="start"
                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-101519 focus:outline-0 focus:ring-0 border border-[#d3dce3] bg-gray-50 focus:border-[#d3dce3] h-14 bg-[image:--select-button-svg] placeholder:text-5a758c p-[15px] text-base font-normal leading-normal"
                required
              >
                <option value="千歳駅">千歳駅</option>
                <option value="南千歳駅">南千歳駅</option>
                <option value="本部棟">本部棟</option>
                <option value="研究実験棟">研究・実験棟</option>
              </select>
            </label>
          </div>
          <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
            <label class="flex flex-col min-w-40 flex-1">
              <p class="text-101519 text-base font-medium leading-normal pb-2">To</p>
              <select
                id="end"
                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-101519 focus:outline-0 focus:ring-0 border border-[#d3dce3] bg-gray-50 focus:border-[#d3dce3] h-14 bg-[image:--select-button-svg] placeholder:text-5a758c p-[15px] text-base font-normal leading-normal"
                required
              >
                <option value="千歳駅">千歳駅</option>
                <option value="南千歳駅">南千歳駅</option>
                <option value="本部棟">本部棟</option>
                <option value="研究実験棟">研究・実験棟</option>
              </select>
            </label>
          </div>
          <div class="flex px-4 py-3 max-w-[480px]">
            <div class="flex h-10 flex-1 items-center justify-center rounded-xl bg-e9eef1 p-1">
              <label
                class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-xl px-2 has-[:checked]:bg-gray-50 has-[:checked]:shadow-[0_0_4px_rgba(0,0,0,0.1)] has-[:checked]:text-101519 text-5a758c text-sm font-medium leading-normal"
              >
                <span class="truncate">Arrive By</span>
                <input type="radio" name="searchOption" id="option-arrival" class="invisible w-0" value="arrival" checked />
              </label>
              <label
                class="flex cursor-pointer h-full grow items-center justify-center overflow-hidden rounded-xl px-2 has-[:checked]:bg-gray-50 has-[:checked]:shadow-[0_0_4px_rgba(0,0,0,0.1)] has-[:checked]:text-101519 text-5a758c text-sm font-medium leading-normal"
              >
                <span class="truncate">Depart At</span>
                <input type="radio" name="searchOption" id="option-departure" class="invisible w-0" value="departure" />
              </label>
            </div>
          </div>
          <div class="flex max-w-[480px] flex-wrap items-end gap-4 px-4 py-3">
            <label class="flex flex-col min-w-40 flex-1">
              <p class="text-101519 text-base font-medium leading-normal pb-2">Time</p>
              <div class="flex w-full flex-1 items-stretch rounded-xl">
                <input
                  id="time"
                  type="time"
                  class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-101519 focus:outline-0 focus:ring-0 border border-[#d3dce3] bg-gray-50 focus:border-[#d3dce3] h-14 placeholder:text-5a758c p-[15px] rounded-r-none border-r-0 pr-2 text-base font-normal leading-normal"
                  required
                />
                <div
                  class="text-5a758c flex border border-[#d3dce3] bg-gray-50 items-center justify-center pr-[15px] rounded-r-xl border-l-0"
                  data-icon="Clock"
                  data-size="24px"
                  data-weight="regular"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                    <path
                      d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"
                    ></path>
                  </svg>
                </div>
              </div>
            </label>
          </div>
          <div class="flex px-4 py-3">
            <button
              type="submit"
              class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-xl h-12 px-5 flex-1 bg-[#3a86c4] text-gray-50 text-base font-bold leading-normal tracking-[0.015em]"
            >
              <span class="truncate">Search</span>
            </button>
          </div>
        </form>
      </div>
      <div id="resultArea" class="fixed inset-0 z-40 hidden flex-col bg-gray-50 dark:bg-[#181f26] transition-colors duration-200"></div>
      <div>
        <div class="flex gap-2 border-t border-[#eaeef1] bg-gray-50 px-4 pb-3 pt-2">
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 rounded-full text-101519" href="#">
            <div class="text-101519 flex h-8 items-center justify-center" data-icon="MagnifyingGlass" data-size="24px" data-weight="fill">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M168,112a56,56,0,1,1-56-56A56,56,0,0,1,168,112Zm61.66,117.66a8,8,0,0,1-11.32,0l-50.06-50.07a88,88,0,1,1,11.32-11.31l50.06,50.06A8,8,0,0,1,229.66,229.66ZM112,184a72,72,0,1,0-72-72A72.08,72.08,0,0,0,112,184Z"
                ></path>
              </svg>
            </div>
            <p class="text-101519 text-xs font-medium leading-normal tracking-[0.015em]">Search</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-5a758c" href="#">
            <div class="text-5a758c flex h-8 items-center justify-center" data-icon="Bookmark" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Zm0,16V161.57l-51.77-32.35a8,8,0,0,0-8.48,0L72,161.56V48ZM132.23,177.22a8,8,0,0,0-8.48,0L72,209.57V180.43l56-35,56,35v29.14Z"
                ></path>
              </svg>
            </div>
            <p class="text-5a758c text-xs font-medium leading-normal tracking-[0.015em]">Saved</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-5a758c" href="#">
            <div class="text-5a758c flex h-8 items-center justify-center" data-icon="Bell" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M221.8,175.94C216.25,166.38,208,139.33,208,104a80,80,0,1,0-160,0c0,35.34-8.26,62.38-13.81,71.94A16,16,0,0,0,48,200H88.81a40,40,0,0,0,78.38,0H208a16,16,0,0,0,13.8-24.06ZM128,216a24,24,0,0,1-22.62-16h45.24A24,24,0,0,1,128,216ZM48,184c7.7-13.24,16-43.92,16-80a64,64,0,1,1,128,0c0,36.05,8.28,66.73,16,80Z"
                ></path>
              </svg>
            </div>
            <p class="text-5a758c text-xs font-medium leading-normal tracking-[0.015em]">Alerts</p>
          </a>
          <a class="just flex flex-1 flex-col items-center justify-end gap-1 text-5a758c" href="#">
            <div class="text-5a758c flex h-8 items-center justify-center" data-icon="User" data-size="24px" data-weight="regular">
              <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                <path
                  d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z"
                ></path>
              </svg>
            </div>
            <p class="text-5a758c text-xs font-medium leading-normal tracking-[0.015em]">Account</p>
          </a>
        </div>
        <div class="h-5 bg-gray-50"></div>
      </div>
    </div>
    <script>
      // --- データ取得 ---
      let data = [];
      fetch(`https://script.google.com/macros/s/AKfycbwFaXX9a-PRN8nruO75vsLAbOGbZAmMOQeoI5bU1z7MNoIPcARLQHSvFiEeF-bkZpvT/exec`, {
        method: 'GET',
        headers: { 'Content-Type': 'text/plain' }
      })
        .then(response => {
          if (!response.ok) throw new Error('ファイル取得に失敗しました');
          return response.json();
        })
        .then(dataD => {
          data = dataD;
        })
        .catch(error => {
          document.getElementById("resultArea").innerHTML = `<div class="text-red-500">${error}</div>`;
        });

      // --- ユーティリティ ---
      function timeToNumber(timeStr) {
        let a = timeStr.split(":").map(x => parseInt(x));
        return a[0] * 60 + a[1];
      }
      function formatTotalMinutes(totalMinutes) {
        const sign = totalMinutes < 0 ? -1 : 1;
        const absoluteMinutes = Math.abs(totalMinutes);
        const hours = Math.floor(absoluteMinutes / 60) * sign;
        const minutes = (absoluteMinutes % 60) * sign;
        let formattedString = "";
        if (hours !== 0) {
          formattedString += `${hours}時間`;
        }
        formattedString += `${minutes}分`;
        return formattedString;
      }

      // --- 検索ロジック ---
      function busFinder(time, from, to, option = "departure", length) {
        let result = [];
        let c = 0;
        let busData;
        if (from.match(/駅/)) {
          busData = data[0];
        } else if (from == "研究実験棟" && to == "本部棟") {
          busData = data[0];
        } else {
          busData = data[1];
        }
        if (option === "departure") {
          for (let i = 0; i < busData.length; i++) {
            if (c >= length) break;
            if (typeof busData[i][to] == "undefined" || typeof busData[i][from] == "undefined") continue;
            if ((timeToNumber(time) < timeToNumber(busData[i][from]))) {
              result.push(busData[i]);
              c++;
            }
          }
        } else {
          for (let i = busData.length - 1; i >= 0; i--) {
            if (c >= length) break;
            if (typeof busData[i][to] == "undefined" || typeof busData[i][from] == "undefined") continue;
            if ((timeToNumber(time) > timeToNumber(busData[i][to]))) {
              result.push(busData[i]);
              c++;
            }
          }
        }
        return result;
      }

      // --- 検索・表示 ---
      document.getElementById("busForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const start = document.getElementById("start").value.trim();
        const end = document.getElementById("end").value.trim();
        const time = document.getElementById("time").value;
        const option = document.querySelector('input[name="searchOption"]:checked').value;
        const resultDiv = document.getElementById("resultArea");
        const searchArea = document.getElementById("searchArea");

        if (!start || !end) {
          resultDiv.innerHTML = `<div class="text-red-500 p-8 text-center">出発地と到着地を入力してください。</div>`;
          resultDiv.classList.remove("hidden");
          searchArea.classList.add("hidden");
          return;
        }
        if (start === end) {
          resultDiv.innerHTML = `<div class="text-red-500 p-8 text-center">出発地と到着地が同じです。</div><div class="flex justify-center mt-4"><button id="backToSearch" class="rounded-xl bg-[#3a86c4] text-gray-50 px-6 py-2 font-bold">検索に戻る</button></div>`;
          resultDiv.classList.remove("hidden");
          searchArea.classList.add("hidden");
          document.getElementById("backToSearch").onclick = () => {
            resultDiv.classList.add("hidden");
            searchArea.classList.remove("hidden");
          };
          return;
        }

        const routes = busFinder(time, start, end, option, 5);

        if (routes.length === 0) {
          resultDiv.innerHTML = `<div class="text-gray-500 p-8 text-center">経路情報が見つかりません。</div>
            <div class="flex justify-center mt-4"><button id="backToSearch" class="rounded-xl bg-[#3a86c4] text-gray-50 px-6 py-2 font-bold">検索に戻る</button></div>`;
          resultDiv.classList.remove("hidden");
          searchArea.classList.add("hidden");
          document.getElementById("backToSearch").onclick = () => {
            resultDiv.classList.add("hidden");
            searchArea.classList.remove("hidden");
          };
          return;
        }

        let output = `
          <div class="flex items-center justify-between p-4 pb-2">
            <h2 class="text-101519 text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Search results</h2>
            <button id="backToSearch" class="rounded-xl bg-[#3a86c4] text-gray-50 px-4 py-1 font-bold ml-4">検索に戻る</button>
          </div>
          <div class="overflow-y-auto" style="max-height:calc(100vh - 120px)">
        `;
        routes.forEach((bus, idx) => {
          output += `
            <div class="bus-result-item flex items-center gap-4 bg-gray-50 dark:bg-[#232b34] px-4 min-h-[72px] py-2 justify-between rounded-xl border mb-2 bus_c cursor-pointer transition hover:bg-blue-100 dark:hover:bg-[#2d3748]" data-idx="${idx}">
              <div class="flex items-center gap-4">
                <div class="text-101518 flex items-center justify-center rounded-lg bg-eaeef1 dark:bg-[#232b34] shrink-0 size-12" data-icon="Bus" data-size="24px" data-weight="regular">
                  <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M184,32H72A32,32,0,0,0,40,64V208a16,16,0,0,0,16,16H80a16,16,0,0,0,16-16V192h64v16a16,16,0,0,0,16,16h24a16,16,0,0,0,16-16V64A32,32,0,0,0,184,32ZM56,176V120H200v56Zm0-96H200v24H56ZM72,48H184a16,16,0,0,1,16,16H56A16,16,0,0,1,72,48Zm8,160H56V192H80Zm96,0V192h24v16Zm-72-60a12,12,0,1,1-12-12A12,12,0,0,1,104,148Zm72,0a12,12,0,1,1-12-12A12,12,0,0,1,176,148Zm72-68v24a8,8,0,0,1-16,0V80a8,8,0,0,1,16,0ZM24,80v24a8,8,0,0,1-16,0V80a8,8,0,0,1,16,0Z"></path>
                  </svg>
                </div>
                <div class="flex flex-col justify-center">
                  <p class="text-101518 text-base font-medium leading-normal line-clamp-1">${bus[start]}</p>
                  <p class="text-5c758a text-sm font-normal leading-normal line-clamp-2">${formatTotalMinutes(timeToNumber(bus[start]) - timeToNumber(new Date().toTimeString().slice(0, 5)))}後</p>
                </div>
              </div>
              <div class="shrink-0"><p class="text-101518 text-base font-normal leading-normal">${bus[end]}</p></div>
            </div>
            ${typeof bus["備考"] === "undefined" ? "" : `<div class="text-xs text-gray-500 px-4 pb-2">※${bus["備考"]}</div>`}
            ${typeof bus["乗り場Bus"] === "undefined" ? "" : `<div class="text-xs text-gray-500 px-4 pb-2">乗り場: ${bus["乗り場Bus"]}</div>`}
          `;
        });
        output += `</div>`;
        resultDiv.innerHTML = output;
        resultDiv.classList.remove("hidden");
        searchArea.classList.add("hidden");

        document.getElementById("backToSearch").onclick = () => {
          resultDiv.classList.add("hidden");
          searchArea.classList.remove("hidden");
        };

        // バス項目クリックで詳細モーダル
        document.querySelectorAll('.bus-result-item').forEach(item => {
          item.onclick = function () {
            const idx = parseInt(this.getAttribute('data-idx'));
            showBusModal(routes[idx], start, end);
          };
        });
      });

      // バス詳細モーダル
      function showBusModal(bus, start, end) {
        // 時刻表生成
        let timetable = '';
        Object.keys(bus).forEach(key => {
          if (["備考", "乗り場Bus"].includes(key)) return;
          timetable += `<tr><td class="px-2 py-1 font-medium">${key}</td><td class="px-2 py-1">${bus[key]}</td></tr>`;
        });
        // カウントダウン
        let targetTime = bus[start];
        let countdownId = "bus-countdown-" + Math.random().toString(36).slice(2);
        let modal = document.createElement('div');
        modal.className = "fullscreen-modal";
        modal.innerHTML = `
          <button class="modal-close" title="閉じる" onclick="this.parentNode.remove()">×</button>
          <div class="modal-content w-full max-w-lg">
            <h3 class="text-xl font-bold mb-2 text-center">${start} → ${end}</h3>
            <div class="text-center mb-4 text-lg">出発時刻: <span class="font-mono">${bus[start]}</span></div>
            <div class="text-center mb-4 text-lg">到着時刻: <span class="font-mono">${bus[end]}</span></div>
            <div class="text-center mb-4 text-lg">出発まで <span id="${countdownId}" class="font-bold text-blue-400">--:--:--</span></div>
            <table class="w-full text-sm mb-4 border rounded-xl overflow-hidden bg-[#232b34]">
              <thead><tr><th class="px-2 py-1">停留所</th><th class="px-2 py-1">時刻</th></tr></thead>
              <tbody>${timetable}</tbody>
            </table>
            ${typeof bus["備考"] === "undefined" ? "" : `<div class="text-xs text-gray-400 pb-2">※${bus["備考"]}</div>`}
            ${typeof bus["乗り場Bus"] === "undefined" ? "" : `<div class="text-xs text-gray-400 pb-2">乗り場: ${bus["乗り場Bus"]}</div>`}
          </div>
        `;
        document.body.appendChild(modal);

        // カウントダウン
        function updateCountdown() {
          let now = new Date();
          let [h, m] = bus[start].split(":").map(Number);
          let target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);
          if (target < now) target.setDate(target.getDate() + 1); // 翌日対応
          let diff = Math.floor((target - now) / 1000);
          let sign = diff < 0 ? "-" : "";
          diff = Math.abs(diff);
          let hh = String(Math.floor(diff / 3600)).padStart(2, "0");
          let mm = String(Math.floor((diff % 3600) / 60)).padStart(2, "0");
          let ss = String(diff % 60).padStart(2, "0");
          let el = document.getElementById(countdownId);
          if (el) el.textContent = `${sign}${hh}:${mm}:${ss}`;
        }
        updateCountdown();
        let timer = setInterval(updateCountdown, 1000);
        modal.querySelector('.modal-close').onclick = function () {
          clearInterval(timer);
          modal.remove();
        };
      }

      // 初期値セット
      window.onload = function () {
        document.getElementById("time").value = new Date().toTimeString().slice(0, 5);
      };
    </script>
  </body>
</html>
