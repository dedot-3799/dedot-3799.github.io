<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>科技大アクセス</title>
    <meta name="description" content="札幌駅または新札幌駅から科技大の行き方を検索する非公式・非公認アプリです。" />
    <meta name="author" content="dedot-3799" />
    <meta name="theme-color" content="#3f51b5" />
    <meta property="og:title" content="CISTへのアクセス" />
    <meta property="og:description" content="札幌駅または新札幌駅から科技大の行き方を検索する非公式・非公認アプリです。" />
    <meta property="og:type" content="website" />
    <style>
        :root {
            --bg-color: #f8f6f4;
            --text-color: #333;
            --card-bg: #fff;
            --primary: #d98d1c;
            --primary-dark: #a76b26;
            --result-bg: #f6efe8;
            --result-text: #222;
            --result-bg2: #ffead0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212;
                --text-color: #f0f0f0;
                --card-bg: #1e1e1e;
                --primary: #7986cb;
                --primary-dark: #5c6bc0;
                --result-bg: #2c2f4a;
                --result-text: #fff;
                --result-bg2: #424980;
            }
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
        }

        .container {
            background: var(--bg-color);
            padding: 2rem;
            width: 100%;
            display: block;
        }

        .container.load {
            display: none;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        label {
            display: block;
            margin: 0.25rem;
            font-weight: bold;
        }

        select,
        input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            background: var(--card-bg);
            color: var(--text-color);
        }

        select:focus,
        input:focus {
            border-color: var(--primary);
        }


        button {
            width: 100%;
            margin-top: 1.5rem;
            padding: 0.75rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--primary-dark);
        }


        input[type="time"]::-webkit-calendar-picker-indicator {
            position: absolute;
            opacity: 0;
        }

        #result {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--result-bg);
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            display: none;
            text-align: left;
        }

        .form-section {
            display: flex;
            flex-wrap: wrap;
        }

        .form-section.collapsed {
            display: none;
        }



        input[type="radio"] {
            display: none;
        }

        .toggle-search,
        .toggle-search:hover {
            margin-top: 1rem;
            display: none;
            background: transparent;
            color: var(--primary);
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            text-decoration: underline;
            margin: 0 0;
        }

        .toggle-search:hover {
            color: var(--primary-dark);
        }

        .bus_c {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background-color: var(--result-bg2);
            color: var(--result-text);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .hide {
            display: none;
        }

        .srhf {
            display: block;
        }

        @media screen and (max-width: 480px) {
            body {
                justify-content: center;
                align-items: center;
            }

            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.2rem;
            }

            button {
                font-size: 0.9rem;
                padding: 0.6rem;
            }

            .form-section {
                display: block;
            }

            select {
                width: 100%;
            }

            input[type="time"] {
                width: calc(100% - 24px);
            }
        }

        .sc {
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            color: var(--text-color);
            z-index: 1;
            font-size: 20vmin;
        }

        .sc.load {
            background-color: relative;
            display: none;
            justify-content: center;
            align-items: center;
            text-align: center;
            display: block;
            color: var(--text-color);
        }

        .radio-group {
            display: flex;
            gap: 16px;
            margin: 8px 0;
        }

        .radio-group label {
            background: var(--background);
            border-radius: 20px;
            padding: 8px 18px;
            cursor: pointer;
            border: 2px solid var(--primary);
            transition: background 0.2s, border 0.2s;
            font-weight: 500;
        }

        .radio-group input[type="radio"] {
            display: none;
        }

        .radio-group input[type="radio"]:checked+span,
        .radio-group input[type="radio"]:checked~label {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .radio-group label:has(input[type="radio"]:checked) {
            background: var(--primary);
            color: #fff;
            border-color: var(--primary);
        }

        .timeline-container {
            width: 350px;
            background-color: var(--background);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .timeline-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 20px;
        }

        .timeline {
            list-style: none;
            padding: 0;
            margin: 0;
            position: relative;
            overflow-x: auto;
        }

        .timeline::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 10px;
            /* ドットの左位置に合わせる */
            width: 2px;
            height: calc(100% - 75px);
            /* 最初のドットと最後のドットの間 */
            background-color: var(--primary);
            z-index: 0;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            position: relative;
            padding-left: 30px;
            margin-bottom: 25px;
        }

        .timeline-dot {
            width: 10px;
            height: 10px;
            background-color: var(--text-color);
            border-radius: 50%;
            position: absolute;
            left: 5.5px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
        }

        .timeline-start .timeline-dot,
        .timeline-end .timeline-dot {
            left: 3.5px;
            background-color: var(--result-bg2);
            border: 3px solid var(--text-color);
        }

        .timeline-content {
            display: flex;
            flex-direction: column;
            margin-left: 15px;
        }

        .timeline-time {
            font-size: 14px;
            color: var(--text-color);
            margin-bottom: 2px;
        }

        .timeline-location {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-color);
        }


        @media screen and (min-width: 784px) {

            .timeline-container {
                width: 90%;
                max-width: 1000px;
                /* 最大幅を設定してPC表示で広がりすぎないようにする */
                border-radius: 12px;
                padding: 30px 20px;
                overflow-x: auto;
            }

            .timeline {
                list-style: none;
                padding: 0;
                margin: 0;
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
                /* ここを修正：下揃えにする */
                position: relative;
            }

            .timeline::before {
                content: '';
                position: absolute;
                top: 79px;
                /* ドットの垂直位置に合わせて調整 */
                left: 75px;
                width: auto;
                right: 36.5px;
                height: 2px;
                z-index: 0;
            }

            .timeline-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                position: relative;
                z-index: 1;
                min-width: 80px;
                /* 項目が狭くなりすぎないように最小幅を設定 */
            }

            .timeline-dot-wrapper {
                position: relative;
                padding-bottom: 20px;
            }

            .timeline-start .timeline-dot,
            .timeline-end .timeline-dot {
                top: 72.5px;
                left: calc(50% + 22.5px);
            }

            .timeline-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                position: absolute;
                bottom: 0;
                /* ここを修正：親要素の下端に配置 */
                left: calc(50% + 22.5px);
                transform: translateX(-50%);
                /* ここを修正：X軸で中央揃えにする */
                z-index: 1;
                top: 75px;
            }

            .timeline-content {
                display: flex;
                flex-direction: column-reverse;
                align-items: center;
                /* テキストを中央揃えにする */
                margin-top: 20px;
            }

            .timeline-location {
                font-size: 16px;
                font-weight: 500;
                white-space: nowrap;
            }

            .timeline-time {
                font-size: 14px;
                margin-top: 5px;
            }
        }

        /* 検索結果カードデザイン */
        #result {
            margin-top: 24px;
            margin-bottom: 24px;
        }

        .bus-result-list {
            display: flex;
            flex-direction: column;
            gap: 18px;
            margin-top: 12px;
        }

        .bus-card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(63, 81, 181, 0.08);
            border: 1px solid var(--primary);
            padding: 18px 20px 14px 20px;
            position: relative;
            transition: box-shadow 0.2s, max-height 0.3s;
            cursor: pointer;
            overflow: hidden;
        }

        .bus-card.open {
            box-shadow: 0 4px 24px rgba(60, 80, 120, 0.08);
            max-height: 500px;
        }

        .bus-card strong {
            font-size: 2.1em;
            color: var(--text-color);
            letter-spacing: 0.5px;
        }

        .bus-card .bus-times {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin: 8px 0 4px 0;
            font-size: 1.05em;
        }

        .bus-card .bus-times .arrow {
            font-size: 1.2em;
            color: var(--text-color);
        }

        .bus-card .bus-meta {
            font-size: 0.98em;
            color: var(--text-color);
            margin-top: 4px;
        }

        .bus-card .bus-meta span {
            margin-right: 16px;
        }

        .bus-card .bus-note {
            color: var(--primary);
            font-size: 0.95em;
            font-weight: 500;
        }

        .bus-detail-content {
            border-top: 1px solid var(--text-color);
            transition: max-height .4s cubic-bezier(.4, 0, .2, 1), opacity .3s;
            max-height: 0;
            opacity: 0;
            pointer-events: none;
            overflow: auto;
            margin-top: 8px;
        }

        .bus-card.open .bus-detail-content {
            max-height: 300px;
            opacity: 1;
            pointer-events: auto;
            display: block;
        }

        .detail-bus {
            display: flex;
            flex-direction: row;
            width: 100%;
            flex-wrap: wrap;
            justify-content: space-between;
        }

        .bus-countdown {
            font-size: 200%;
            width: max-content;
        }
    </style>
</head>
<div class="sc load">
    <span id="loadStatus">Loading...</span>
</div>

<body>
    <div class="container load">
        <h1 onclick="toggleForm()">CIST Access</h1>

        <div class="form-section" id="searchForm">
            <label for="start" class="srhf">出発
                <select type="text" id="start">
                    <option value="札幌駅">札幌駅</option>
                    <option value="新札幌駅">新札幌駅</option>
                    <option value="千歳駅">千歳駅</option>
                    <option value="南千歳駅" selected>南千歳駅</option>
                    <option value="本部棟">本部棟</option>
                    <option value="研究実験棟">研究・実験棟</option>
                </select></label>

            <label for="end" class="srhf">到着
                <select type="text" id="end">
                    <option value="札幌駅">札幌駅</option>
                    <option value="新札幌駅">新札幌駅</option>
                    <option value="千歳駅">千歳駅</option>
                    <option value="南千歳駅">南千歳駅</option>
                    <option value="本部棟" selected>本部棟</option>
                    <option value="研究実験棟">研究・実験棟</option>
                </select></label>

            <label class="srhf">
                <div id="option-group" class="radio-group">
                    <label>
                        <input type="radio" name="option" value="departure" checked>
                        出発時刻
                    </label>
                    <label>
                        <input type="radio" name="option" value="arrival">
                        到着時刻
                    </label>
                </div>
            </label>
            <input type="time" id="time" value="08:00" />

            <h6 style="color: #888; margin: 18px 0 -12px 0;">最大5件まで表示されます。</h6>
            <button onclick="searchRoute()">検索</button>
        </div>
        <div id="result"></div><button id="toggle-search" class="toggle-search" onclick="toggleForm()">検索条件を変更</button>
    </div>
    <script>let data = [];
        let tdata = {};

        fetch(`https://script.google.com/macros/s/AKfycbwFaXX9a-PRN8nruO75vsLAbOGbZAmMOQeoI5bU1z7MNoIPcARLQHSvFiEeF-bkZpvT/exec`, {
            method: 'GET',
            headers: {
                'Content-Type': 'text/plain'
            },
        })
            // data.jsonは同じディレクトリ内のファイル名
            .then(response => {
                if (!response.ok) throw new Error('ファイル取得に失敗しました');
                return response.json(); // JSONとしてパース
            })
            .then(dataD => {
                // データをHTMLに表示（例として "name" を表示）
                console.log(dataD)
                data = dataD;
                let d = document.getElementsByTagName('*');
                for (let i = 0; i < d.length; i++) {
                    d[i].classList.remove('load');
                }
            })
            .catch(error => {
                loadStatus.textContent = error;
                console.error('エラー:', error);
            });

        fetch(`https://script.google.com/macros/s/AKfycbwWfnCBAIWII2TzLiqx3UB1DLECGGKDG0hXTf3-RtJYkVGkteqnbJuocZsirbMZEWXO/exec`, {
            method: 'GET',
            headers: {
                'Content-Type': 'text/plain'
            },
        })
            // data.jsonは同じディレクトリ内のファイル名
            .then(response => {
                if (!response.ok) throw new Error('ファイル取得に失敗しました');
                return response.json(); // JSONとしてパース
            })
            .then(dataD => {
                // データをHTMLに表示（例として "name" を表示）
                console.log(dataD)
                tdata = dataD;
            })
            .catch(error => {
                loadStatus.textContent = error;
                console.error('エラー:', error);
            });

        function timeToNumber(timeStr) {
            let a = timeStr.split(":").map(x => parseInt(x));
            return a[0] * 60 + a[1];
        }

        function timeToSecondsNumber(times) {
            let a = times.split(":").map(x => parseInt(x));
            console.log(a);
            return a[0] * 3600 + a[1] * 60 + a[2];
        }

        function trainBusFinder(time, from, to, option = "departure", length) {
            let result = [];
            let c = 0;
            // 電車データ取得
            let trainData = [], flag = false;
            if ((to == "札幌駅" && (from == "本部棟" || from == "研究実験棟")) ||
                (to == "新札幌駅" && (from == "本部棟" || from == "研究実験棟"))) {
                // ディープコピー
                trainData = JSON.parse(JSON.stringify(tdata["ミセ発"]));
                flag = true;
            } else if ((from == "札幌駅" && (to == "本部棟" || to == "研究実験棟")) ||
                (from == "新札幌駅" && (to == "本部棟" || to == "研究実験棟"))) {
                // ディープコピー
                trainData = JSON.parse(JSON.stringify(tdata["ミセ着"]));
                flag = false;
            } else {
                console.log("undefined")
                return [];
            }
            switch (option) {
                case "departure": {
                    for (let i = 0; i < trainData.length; i++) {
                        if (c >= length) break;
                        if (typeof trainData[i][!flag ? "stopTime" : "bus"][from] == "undefined" || typeof trainData[i][flag ? "stopTime" : "bus"][to] == "undefined") continue;
                        if ((timeToNumber(time) < timeToNumber(trainData[i][!flag ? "stopTime" : "bus"][from]))) {
                            let tmp = {};
                            delete trainData[i]["bus"]["千歳駅"];
                            trainData[i]["stopTime"][flag ? "南千歳駅発" : "南千歳駅着"] = trainData[i]["stopTime"]["南千歳駅"];
                            delete trainData[i]["stopTime"]["南千歳駅"];
                            trainData[i]["bus"][flag ? "南千歳駅着" : "南千歳駅発"] = trainData[i]["bus"]["南千歳駅"];
                            delete trainData[i]["bus"]["南千歳駅"];
                            if (flag) tmp = { ...trainData[i]["bus"], ...trainData[i]["stopTime"] }; else tmp = { ...trainData[i]["stopTime"], ...trainData[i]["bus"] };
                            let ent = Object.entries(tmp);
                            ent.sort((a, b) => timeToNumber(a[1]) - timeToNumber(b[1]));
                            tmp = Object.fromEntries(ent);
                            result.push({ trainNumber: trainData[i].trainNumber, result: tmp });
                            c++;
                        }
                    }
                    break;
                }
                case "arrival": {
                    for (let i = trainData.length - 1; i >= 0; i--) {
                        if (c >= length) break;
                        if (typeof trainData[i][!flag ? "stopTime" : "bus"][from] == "undefined" || typeof trainData[i][flag ? "stopTime" : "bus"][to] == "undefined") continue;
                        if ((timeToNumber(time) > timeToNumber(trainData[i][flag ? "stopTime" : "bus"][to]))) {
                            let tmp;
                            delete trainData[i]["bus"]["千歳駅"];
                            trainData[i]["stopTime"][flag ? "南千歳駅発" : "南千歳駅着"] = trainData[i]["stopTime"]["南千歳駅"];
                            delete trainData[i]["stopTime"]["南千歳駅"];
                            trainData[i]["bus"][flag ? "南千歳駅着" : "南千歳駅発"] = trainData[i]["bus"]["南千歳駅"];
                            delete trainData[i]["bus"]["南千歳駅"];
                            if (flag) tmp = { ...trainData[i]["bus"], ...trainData[i]["stopTime"] }; else tmp = { ...trainData[i]["stopTime"], ...trainData[i]["bus"] };
                            let ent = Object.entries(tmp);
                            ent.sort((a, b) => timeToNumber(a[1]) - timeToNumber(b[1]));
                            tmp = Object.fromEntries(ent);
                            result.push({ trainNumber: trainData[i].trainNumber, result: tmp });
                            c++;
                        }
                    }
                    break;
                }
                default:
                    break;
            }
            console.log(result);
            return result;
        }

        function busFinder(time, from, to, option = "departure", length) {
            let result = [];
            let c = 0;
            switch (option) {
                // 出発時間の指定
                case "departure": {
                    // バスデータ取得
                    let busData;
                    if (from.match(/駅/)) {
                        busData = data[0];
                    } else if (from == "研究実験棟" && to == "本部棟") {
                        busData = data[0];
                    } else {
                        busData = data[1];
                    }
                    for (let i = 0; i < busData.length; i++) {
                        if (c >= length) break;
                        if (typeof busData[i][to] == "undefined" || typeof busData[i][from] == "undefined") continue;
                        if ((timeToNumber(time) < timeToNumber(busData[i][from]))) {
                            result.push({ result: busData[i] });
                            c++;
                        }
                    }
                    break;
                }
                // 到着時間の指定
                case "arrival": {
                    // バスデータ取得
                    let busData;
                    if (from.match(/駅/)) {
                        busData = data[0];
                    } else if (from == "研究実験棟" && to == "本部棟") {
                        busData = data[0];
                    } else {
                        busData = data[1];
                    }
                    for (let i = busData.length - 1; i >= 0; i--) {
                        if (c >= length) break;
                        if (typeof busData[i][to] == "undefined" || typeof busData[i][from] == "undefined") continue;
                        if ((timeToNumber(time) > timeToNumber(busData[i][to]))) {
                            result.push({ result: busData[i] });
                            c++;
                        }
                    }
                    break;
                }
                default:
                    break;
            }
            return result;
        }

        let firstSearch = false;

        function toggleForm() {
            if (!firstSearch) return;
            const form = document.getElementById("searchForm");
            const toggleBtn = document.getElementById("toggle-search");
            form.classList.toggle("collapsed");
            if (form.classList.contains("collapsed")) {
                toggleBtn.textContent = "検索条件を変更";
                document.getElementById("result").style.display = "block";
            } else {
                toggleBtn.textContent = "検索結果に戻る";
                document.getElementById("result").style.display = "none";
            }
        }

        function formatTotalMinutes(totalMinutes) {
            const sign = totalMinutes < 0 ? -1 : 1;
            const absoluteMinutes = Math.abs(totalMinutes);
            const hours = Math.floor(absoluteMinutes / 60) * sign;
            const minutes = (absoluteMinutes % 60) * sign;

            let formattedString = "";
            if (hours !== 0) {
                formattedString += `${hours}時間`;
            }
            formattedString += `${minutes}分`;

            return formattedString;
        }

        function trainumbertoname(trainnm) {
            if (trainnm.length != 5) return;
            if (trainnm.startsWith("3")) {
                return `快速エアポート${Number(trainnm.substr(0, 4)) - 3800}号`
            } else if (trainnm.startsWith("4")) {
                return `特別快速エアポート${Number(trainnm.substr(0, 4)) - 4800}号`
            } else if (trainnm.startsWith("5")) {
                return `区間快速エアポート${Number(trainnm.substr(0, 4)) - 5800}号`
            } else {
                return;
            }
        }

        function searchRoute() {
            const start = document.getElementById("start").value.trim();
            const end = document.getElementById("end").value.trim();
            const resultDiv = document.getElementById("result");
            const form = document.getElementById("searchForm");
            const toggleBtn = document.getElementById("toggle-search");
            const option = document.querySelector('input[name="option"]:checked').value;
            firstSearch = true;
            if (!start || !end) {
                resultDiv.innerHTML = "出発地と到着地を入力してください。";
                resultDiv.style.display = "block";
                return;
            }

            if (start === end) {
                resultDiv.innerHTML = "出発地と到着地が同じです。";
                resultDiv.style.display = "block";
                form.classList.add("collapsed");
                toggleBtn.style.display = "block";
                return;
            }
            let routes;
            if ((end == "札幌駅" && (start == "本部棟" || start == "研究実験棟")) ||
                (end == "新札幌駅" && (start == "本部棟" || start == "研究実験棟")) ||
                (start == "札幌駅" && (end == "本部棟" || end == "研究実験棟")) ||
                (start == "新札幌駅" && (end == "本部棟" || end == "研究実験棟"))) {
                routes = trainBusFinder(
                    document.getElementById("time").value,
                    start,
                    end,
                    option,
                    5
                );
            } else if ((["千歳駅", "南千歳駅", "研究実験棟"].includes(start) && ["千歳駅", "南千歳駅", "本部棟"].includes(end)) || (["千歳駅", "南千歳駅", "研究実験棟"].includes(end) && ["千歳駅", "南千歳駅", "本部棟"].includes(start))) {
                routes = busFinder(
                    document.getElementById("time").value,
                    start,
                    end,
                    option,
                    5
                );
            } else {
                resultDiv.innerHTML = `${start} から ${end} までの経路案内はサポートされていません。`;
                resultDiv.style.display = "block";
                form.classList.add("collapsed");
                toggleBtn.style.display = "block";
                return;
            }

            if (routes.length === 0) {
                resultDiv.innerHTML = "経路情報が見つかりません。";
                resultDiv.style.display = "block";
                form.classList.add("collapsed");
                toggleBtn.style.display = "block";
                return;
            }

            let output = `<strong>検索結果: ${routes.length}件</strong><h6 style="margin-bottom:10px;">検索条件: ${option === "departure" ? `${start} を ${document.getElementById("time").value} に出発して ${end} に到着するような経路` : `${start} を出発して ${document.getElementById("time").value} までに ${end} に到着するような経路`}</h6>`;
            output += `<div class="bus-result-list">`;
            routes.forEach((rt, idx) => {
                let bus = rt.result;
                let countdownId = "bus-countdown-" + Math.random().toString(36).slice(2);
                output += `
                <div class="bus-card" data-idx="${idx}">
                    <strong>${bus[start]} → ${bus[end]} </strong>  (${timeToNumber(bus[end]) - timeToNumber(bus[start])}分)
                    <div class="bus-times">
                        ${typeof bus["南千歳駅発"] != "undefined" || typeof bus["南千歳駅着"] != "undefined" ? (timeToNumber(bus["南千歳駅発"]) - timeToNumber(bus["南千歳駅着"]) < 5 ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="var(--text-color)" viewBox="0 0 256 256"><path d="M236.8,188.09,149.35,36.22h0a24.76,24.76,0,0,0-42.7,0L19.2,188.09a23.51,23.51,0,0,0,0,23.72A24.35,24.35,0,0,0,40.55,224h174.9a24.35,24.35,0,0,0,21.33-12.19A23.51,23.51,0,0,0,236.8,188.09ZM222.93,203.8a8.5,8.5,0,0,1-7.48,4.2H40.55a8.5,8.5,0,0,1-7.48-4.2,7.59,7.59,0,0,1,0-7.72L120.52,44.21a8.75,8.75,0,0,1,15,0l87.45,151.87A7.59,7.59,0,0,1,222.93,203.8ZM120,144V104a8,8,0,0,1,16,0v40a8,8,0,0,1-16,0Zm20,36a12,12,0,1,1-12-12A12,12,0,0,1,140,180Z"></path></svg>乗換時間が短いです' : "") : ""}${typeof bus["備考"] === "undefined" ? "" : (bus["備考"].length > 7 ? "詳細な運行情報あり" : `<div class="bus-note">${bus["備考"]}</div>`)}${typeof bus["乗り場"] === "undefined" ? "" : (start == "本部棟" ? `<span>乗り場: ${bus["乗り場"]}</span>` : "")}<span style="margin-left:auto;font-weight:500;" id="${countdownId}">${timeToNumber(bus[start]) - timeToNumber(new Date().toTimeString().slice(0, 5)) >= 0 ? "あと" : ""}${formatTotalMinutes(Math.abs(timeToNumber(bus[start]) - timeToNumber(new Date().toTimeString().slice(0, 5))))}${timeToNumber(bus[start]) - timeToNumber(new Date().toTimeString().slice(0, 5)) >= 0 ? "" : "前"} </span>
                    </div>
                    
                    <div class="bus-detail-content"></div>
                </div>
                `;
                // setTimeout再帰呼び出しで誤差を減らす
                let timer = null;
                function updateCountdown() {
                    let now = new Date();
                    let [h, m] = bus[start].split(":").map(Number);
                    let target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);
                    let diff = Math.floor((target - now) / 1000);
                    let sign = diff < 0;
                    diff = Math.abs(diff);
                    let hh = String(Math.floor(diff / 3600)).padStart(2, "0");
                    let mm = String(Math.floor((diff % 3600) / 60)).padStart(2, "0");
                    let ss = String(diff % 60).padStart(2, "0");
                    let el = document.getElementById(countdownId);
                    if (el) el.textContent = `${sign ? "" : "あと"}${hh == "00" ? "" : hh + "時間"}${mm == "00" ? "" : mm + "分"}${(hh != "00" || mm != "00") ? "" : ss + "秒"}${sign ? "前" : ""}`;
                    let next = 1000 - (now.getMilliseconds());
                    timer = setTimeout(updateCountdown, next);
                }
                updateCountdown();
                // タイマーIDをbusカードに保存
                let card = document.querySelector(`.bus-card[data-idx="${idx}"]`);
                if (card) card._countdownTimer = timer;
            });
            output += `</div>`;
            resultDiv.innerHTML = output;
            resultDiv.style.display = "block";
            form.classList.add("collapsed");
            toggleBtn.style.display = "block";

            // バスカードクリックで詳細展開
            document.querySelectorAll('.bus-card').forEach(card => {
                card.addEventListener('click', function (e) {
                    let alreadyOpen = this.classList.contains("open");
                    document.querySelectorAll('.bus-card.open').forEach(el => {
                        el.classList.remove("open");
                        let detail = el.querySelector('.bus-detail-content');
                        // setTimeout再帰呼び出しを止める
                        if (detail && detail._timer) {
                            clearTimeout(detail._timer);
                            detail._timer = null;
                        }
                        // 一覧のカウントダウンタイマーも止める
                        if (el._countdownTimer) {
                            clearTimeout(el._countdownTimer);
                            el._countdownTimer = null;
                        }
                        detail.innerHTML = "";
                        detail.style.maxHeight = "0";
                        detail.style.opacity = "0";
                        detail.style.pointerEvents = "none";
                    });
                    if (alreadyOpen) return;
                    this.classList.add("open");
                    let idx = parseInt(this.getAttribute('data-idx'));
                    let bus = routes[idx].result;
                    let detail = this.querySelector('.bus-detail-content');
                    // 詳細内容生成

                    let timelineData = [];
                    Object.keys(bus).forEach(key => {
                        if (["備考", "乗り場Bus", "乗り場"].includes(key)) return;
                        if (key.match(/乗り場/)) return;
                        if (key == start) {
                            timelineData.push({ time: bus[key], location: key, type: 'start' });
                            return;
                        } else if (key == end) {
                            timelineData.push({ time: bus[key], location: key, type: 'end' });
                            return;
                        } else {
                            timelineData.push({ time: bus[key], location: key });
                        }
                    });

                    let gw, fl = false;
                    try {
                        if (start == "南千歳駅") {
                            gw = tdata["ミセ着"].filter(s => s.busTime == bus[start]);
                            if (gw.length == 1) fl = true;
                        } else if (end == "南千歳駅") {
                            gw = tdata["ミセ発"].filter(s => s.busTime == bus[end]);
                            if (gw.length == 1) fl = true;
                        }

                    } catch { fl = false }

                    let countdownId = "bus-countdown-" + Math.random().toString(36).slice(2);
                    detail.innerHTML = `
                        <div class="detail-bus">
                        <div class="text-center mb-2 text-lg" style="display:flex;flex-direction:column;"><span>${start} 出発まで</span> <span class="bus-countdown" id="${countdownId}" class="font-bold">--:--:--</span>${typeof routes[idx].trainNumber !== "undefined" ? "<span>" + (start.match(/駅/) ? "" : "南千歳駅から ") + trainumbertoname(routes[idx].trainNumber) + " に乗車</span>" : ""}</div>
                            <ul class="timeline"></ul>
                        ${typeof bus["備考"] === "undefined" ? "" : `<div class="text-xs" style="color:#d32f2f;">※${bus["備考"]}</div>`}
                        ${typeof bus["乗り場Bus"] === "undefined" ? "" : `<div class="text-xs" style="color:#555;">乗り場: ${bus["乗り場Bus"]}</div>`}</div>
                    `;
                    const timelineList = document.querySelector('.timeline');
                    // タイムラインの項目を動的に生成
                    timelineData.forEach(item => {
                        const li = document.createElement('li');
                        li.classList.add('timeline-item');
                        if (item.type === 'start' || item.type === 'end') {
                            li.classList.add(`timeline-${item.type}`);
                        }

                        li.innerHTML = `
        <div class="timeline-dot"></div>
        <div class="timeline-content">
            <span class="timeline-time">${item.time}</span>
            <span class="timeline-location">${item.location}</span>
        </div>
    `
                        timelineList.appendChild(li);
                    });

                    // カウントダウン
                    function updateCountdown() {
                        let now = new Date();
                        let [h, m] = bus[start].split(":").map(Number);
                        let target = new Date(now.getFullYear(), now.getMonth(), now.getDate(), h, m, 0);
                        if (target < now) target.setDate(target.getDate() + 1); // 翌日対応
                        let diff = Math.floor((target - now) / 1000);
                        let sign = diff < 0 ? "-" : "";
                        diff = Math.abs(diff);
                        let hh = String(Math.floor(diff / 3600)).padStart(2, "0");
                        let mm = String(Math.floor((diff % 3600) / 60)).padStart(2, "0");
                        let ss = String(diff % 60).padStart(2, "0");
                        let el = document.getElementById(countdownId);
                        if (el) el.textContent = `${sign}${hh == "00" ? "" : hh + "時間"}${mm == "00" ? "" : mm + "分"}${ss + "秒"}`;
                        let next = 1000 - (now.getMilliseconds());
                        detail._timer = setTimeout(updateCountdown, next);
                    }
                    updateCountdown();
                    detail.style.maxHeight = "300px";
                    detail.style.opacity = "1";
                    detail.style.pointerEvents = "auto";
                });
            });
        }

        function settingsSave() {
            const start = document.getElementById("start").value;
            const end = document.getElementById("end").value;
            // ラジオボタンの値取得
            const option = document.querySelector('input[name="option"]:checked').value;
            const time = document.getElementById("time").value;
            const settingData = {
                start: start,
                end: end,
                option: option,
                time: time
            };
            localStorage.setItem("settings", JSON.stringify(settingData));
        }
        function settingsLoad() {
            const settings = JSON.parse(localStorage.getItem("settings"));
            if (!settings) return;
            let keys = Object.keys(settings);
            keys.forEach((key) => {
                if (key === "option") {
                    // ラジオボタンの選択状態復元
                    const radio = document.querySelector(`input[name="option"][value="${settings[key]}"]`);
                    if (radio) radio.checked = true;
                    return;
                }
                if (key === "time") {
                    return;
                }
                const selectElement = document.getElementById(key);
                let options = selectElement.options;
                for (let i = 0; i < options.length; i++) {
                    if (options[i].value === settings[key]) {
                        options[i].selected = true;
                        break;
                    }
                }
            })
        }

        // ページが読み込まれたときに設定を読み込む
        window.onload = function () {
            settingsLoad();
            document.getElementById("time").value = new Date().toTimeString().slice(0, 5);
        };
        ["start", "end", "time"].forEach((el) => {
            document.getElementById(el).addEventListener("change", settingsSave);
        });
        // ラジオボタンにもイベント追加
        document.querySelectorAll('input[name="option"]').forEach((el) => {
            el.addEventListener("change", settingsSave);
        });
    </script>
</body>

</html>
