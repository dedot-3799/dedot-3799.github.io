<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>バス</title>
    <style>
        :root {
            --bg-color: #f4f6f8;
            --text-color: #333;
            --card-bg: #fff;
            --primary: #3f51b5;
            --primary-dark: #303f9f;
            --result-bg: #e8eaf6;
            --result-text: #222;
            --result-bg2: #d0d0ff;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212;
                --text-color: #f0f0f0;
                --card-bg: #1e1e1e;
                --primary: #7986cb;
                --primary-dark: #5c6bc0;
                --result-bg: #2c2f4a;
                --result-text: #fff;
                --result-bg2: #424980;
            }
        }

        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .container {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            display: block;
        }

        .container.load {
            display: none;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        label {
            display: block;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        select,
        input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            outline: none;
            background: var(--card-bg);
            color: var(--text-color);
        }

        select:focus,
        input:focus {
            border-color: var(--primary);
        }

        button {
            width: 100%;
            margin-top: 1.5rem;
            padding: 0.75rem;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--primary-dark);
        }

        #result {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: var(--result-bg);
            border-left: 4px solid var(--primary);
            border-radius: 8px;
            display: none;
            text-align: left;
        }

        .form-section.collapsed {
            display: none;
        }

        .toggle-search,
        .toggle-search:hover {
            margin-top: 1rem;
            display: none;
            background: transparent;
            color: var(--primary);
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            text-decoration: underline;
            margin: 0 0;
        }

        .toggle-search:hover {
            color: var(--primary-dark);
        }

        .bus_c {
            margin: 0.5rem 0;
            padding: 0.5rem;
            background-color: var(--result-bg2);
            color: var(--result-text);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .hide {
            display: none;
        }

        @media screen and (max-width: 480px) {
            .container {
                padding: 1rem;
                border-radius: 12px;
            }

            h1 {
                font-size: 1.2rem;
            }

            button {
                font-size: 0.9rem;
                padding: 0.6rem;
            }
        }



        .sc {
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            color: #fff;
            z-index: 1;
            font-size:20vmin;
        }
        .sc.load {
            background-color: relative;
            display: none;
            justify-content: center;
            align-items: center;
            text-align: center;
            display: block;
            color: #fff;
        }
    </style>
</head>
<div class="sc load">
        <span id="loadStatus">Loading...</span>
</div>
<body>
    <div class="container load">
        <h1>CISTのバス</h1>

        <div class="form-section" id="searchForm">
            <label for="start">出発</label>
            <select type="text" id="start">
                <option value="千歳駅">千歳駅</option>
                <option value="南千歳駅" selected>南千歳駅</option>
                <option value="本部棟">本部棟</option>
                <option value="研究実験棟">研究・実験棟</option>
            </select>

            <label for="end">到着</label>
            <select type="text" id="end">
                <option value="千歳駅">千歳駅</option>
                <option value="南千歳駅">南千歳駅</option>
                <option value="本部棟" selected>本部棟</option>
                <option value="研究実験棟">研究・実験棟</option>
            </select>

            <label for="option">検索条件</label>
            <select id="option">
                <option value="departure">出発時刻</option>
                <option value="arrival">到着時刻</option>
            </select>
            <br><br>
            <input type="time" id="time" value="08:00" style="width: calc(100% - 25px)" />

            <h6 style="color: #888; margin: 18px 0 -12px 0;">最大5件まで表示されます。</h6>
            <button onclick="searchRoute()">検索</button>

        </div>
        <div id="result"></div><button id="toggle-search" class="toggle-search" onclick="toggleForm()">検索条件を変更</button>
    </div>

    <script>
        let data = [];
        
        fetch(`https://script.google.com/macros/s/AKfycbwFaXX9a-PRN8nruO75vsLAbOGbZAmMOQeoI5bU1z7MNoIPcARLQHSvFiEeF-bkZpvT/exec`, {
  method: 'GET',
  headers: {
    'Content-Type': 'text/plain'
  },
})  // data.jsonは同じディレクトリ内のファイル名
      .then(response => {
        if (!response.ok) throw new Error('ファイル取得に失敗しました');
        return response.json(); // JSONとしてパース
      })
      .then(dataD => {
        // データをHTMLに表示（例として "name" を表示）
        console.log(dataD)
        data=dataD;
        let d = document.getElementsByTagName('*');
        for (let i = 0; i < d.length; i++) {
            d[i].classList.remove('load');
        }
      })
      .catch(error => {
        loadStatus.textContent = error;
        console.error('エラー:', error);
      }); 
/*
      const xhr = new XMLHttpRequest();
    xhr.open('GET', 'https://script.google.com/macros/s/AKfycbzyNADRkbfKmPATQH0t7cBXM4O3YKHr-O1Bv7X0S8tzfz7n-lumMDdZR1UboyyfhfvL/exec', true); // 非同期でJSONファイルを取得

    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) { // リクエスト完了
        if (xhr.status === 200) { // 成功
          try {
            const dataD = JSON.parse(xhr.responseText); // JSONをパース
            // データをHTMLに表示（例として "name" を表示）
        console.log(dataD);
        data=dataD;
        let d = document.getElementsByTagName('*');
        for (let i = 0; i < d.length; i++) {
            d[i].classList.remove('load');
        }
          } catch (e) {
            console.error('JSONのパースエラー', e);
          }
        } else {
          console.error('ファイル取得失敗', xhr.status);
          loadStatus.textContent = xhr.statusText;
        }
      }
    };

    xhr.send();
*/

        function timeToNumber(timeStr) {
            let a = timeStr.split(":").map(x => parseInt(x));
            return a[0] * 60 + a[1];
        }

        function timeToSecondsNumber(times) {
            let a = times.split(":").map(x => parseInt(x));
            console.log(a);
            return a[0] * 3600 + a[1] * 60 + a[2];
        }

        function busFinder(time, from, to, option = "departure", length) {
            let result = [];
            let c = 0;
            switch (option) {
                // 出発時間の指定
                case "departure": {
                    // バスデータ取得
                    let busData;
                    if (from.match(/駅/)) {
                        busData = data[0];
                    } else if (from == "研究実験棟" && to == "本部棟") {
                        busData = data[0];
                    } else {
                        busData = data[1];
                    }
                    for (let i = 0; i < busData.length; i++) {
                        if (c >= length) break;
                        if (typeof busData[i][to] == "undefined" || typeof busData[i][from] == "undefined") continue;
                        if ((timeToNumber(time) < timeToNumber(busData[i][from]))) {
                            result.push(busData[i]);
                            c++;
                        }
                    }
                    break;
                }
                // 到着時間の指定
                case "arrival": {
                    // バスデータ取得
                    let busData;
                    if (from.match(/駅/)) {
                        busData = data[0];
                    } else {
                        busData = data[1];
                    }
                    for (let i = busData.length - 1; i >= 0; i--) {
                        if (c >= length) break;
                        if (typeof busData[i][to] == "undefined" || typeof busData[i][from] == "undefined") continue;
                        if ((timeToNumber(time) > timeToNumber(busData[i][to]))) {
                            result.push(busData[i]);
                            c++;
                        }
                    }
                    break;
                }
                default:
                    break;
            }
            return result;
        }

        function toggleForm() {
            const form = document.getElementById("searchForm");
            const toggleBtn = document.getElementById("toggle-search");
            form.classList.toggle("collapsed");
            if (form.classList.contains("collapsed")) {
                toggleBtn.textContent = "検索条件を変更";
                document.getElementById("result").style.display = "block";
            } else {
                toggleBtn.textContent = "検索結果に戻る";
                document.getElementById("result").style.display = "none";
            }
        }

        function formatTotalMinutes(totalMinutes) {
            const sign = totalMinutes < 0 ? -1 : 1;
            const absoluteMinutes = Math.abs(totalMinutes);
            const hours = Math.floor(absoluteMinutes / 60) * sign;
            const minutes = (absoluteMinutes % 60) * sign;

            let formattedString = "";
            if (hours !== 0) {
                formattedString += `${hours}時間`;
            }
            formattedString += `${minutes}分`;

            return formattedString;
        }

        function searchRoute() {
            const start = document.getElementById("start").value.trim();
            const end = document.getElementById("end").value.trim();
            const resultDiv = document.getElementById("result");
            const form = document.getElementById("searchForm");
            const toggleBtn = document.getElementById("toggle-search");
            if (!start || !end) {
                resultDiv.innerHTML = "出発地と到着地を入力してください。";
                resultDiv.style.display = "block";
                return;
            }

            const routes = busFinder(
                document.getElementById("time").value,
                start,
                end,
                document.getElementById("option").value,
                5
            );
            if (start === end) {
                resultDiv.innerHTML = "出発地と到着地が同じです。";
                resultDiv.style.display = "block";
                form.classList.add("collapsed");
                toggleBtn.style.display = "block";
                return;
            }

            if (routes.length === 0) {
                resultDiv.innerHTML = "経路情報が見つかりません。";
                resultDiv.style.display = "block";
                form.classList.add("collapsed");
                toggleBtn.style.display = "block";
                return;
            }

            let output = `<strong>検索結果: ${routes.length}件</strong><h6>検索条件: ${document.getElementById("option").value === "departure" ? `${start} を ${document.getElementById("time").value} に出発して ${end} に到着するようなバス` : `${start} を出発して ${document.getElementById("time").value} までに ${end} に到着するようなバス`}</h6>`;
            var n = 0;
            routes.forEach((time) => {
                n++
                output += `<div class="bus_c"><strong>${n}. ${start} ${time[start]} → ${end} ${time[end]} (あと ${formatTotalMinutes(timeToNumber(time[start]) - timeToNumber(new Date().toTimeString().slice(0, 5)))} )</strong>${typeof time["備考"] === "undefined" ? "" : "<br>※" + time["備考"] + ""}<br>${typeof time["乗り場Bus"] === "undefined" ? "" : "乗り場:" + time["乗り場Bus"] + ""}</div>`;

            });
            resultDiv.innerHTML = output;
            resultDiv.style.display = "block";
            form.classList.add("collapsed");
            toggleBtn.style.display = "block";
        }

        function settingsSave() {
            const start = document.getElementById("start").value;
            const end = document.getElementById("end").value;
            const option = document.getElementById("option").value;
            const time = document.getElementById("time").value;
            const settingData = {
                start: start,
                end: end,
                option: option,
                time: time
            };
            localStorage.setItem("settings", JSON.stringify(settingData));
        }
        function settingsLoad() {
            const settings = JSON.parse(localStorage.getItem("settings"));
            if (!settings) return;
            let keys = Object.keys(settings);
            keys.forEach((key) => {
                const selectElement = document.getElementById(key);
                if (key === "time") {
                    return;
                }
                let options = selectElement.options;
                for (let i = 0; i < options.length; i++) {
                    if (options[i].value === settings[key]) {
                        options[i].selected = true; // "Banana"が選択される
                        break;
                    }
                }
            })
        }
        
        // ページが読み込まれたときに設定を読み込む
        window.onload = function () {
            settingsLoad();
            document.getElementById("time").value = new Date().toTimeString().slice(0, 5);
        };
        ["start", "option", "end", "time"].forEach((el) => {
            document.getElementById(el).addEventListener("change", settingsSave);
        })


    </script>
</body>

</html>